# Usurper Reloaded - Development Log (January 9, 2026)

## Major Update: .NET 8.0 Upgrade, Bounty System Overhaul, Inventory Improvements

Today's session focused on upgrading the runtime, fixing the bounty/quest system, and improving the inventory management experience.

---

## .NET 8.0 Upgrade

### Why Upgrade?
.NET 6.0 reached end-of-life in November 2024. Upgraded to .NET 8.0 (LTS) which is supported until November 2026.

### Changes Made
- **usurper-reloaded.csproj**: Changed `TargetFramework` from `net6.0` to `net8.0`
- **Package Updates**: `Microsoft.Extensions.DependencyInjection` updated from 6.0.0 to 8.0.0
- **Fixed encoding issues**: Rewrote csproj file to resolve UTF-16 BOM corruption
- **Fixed namespace conflicts**: Resolved `MagicItemType` enum conflict between `UsurperRemake` and global namespaces

### Documentation Updates
- Removed all Godot references (no longer using Godot engine)
- Updated README.md, CLAUDE.md, and in-game credits
- Added Discord server link: https://discord.gg/BqY66QkPGE

---

## Bounty System Overhaul

### The Problem
The bounty system was completely broken:
1. Players had to "claim" a bounty before killing the NPC
2. After killing the target, nothing happened - no reward
3. Bounties for dead NPCs stayed on the board indefinitely
4. Two separate bounty systems existed (Anchor Road vs Quest Hall)

### The Solution: Open Contract System

**Bounties are now open contracts:**
- No claiming required
- Kill an NPC with a bounty → immediate gold reward
- Visual feedback: `*** BOUNTY COLLECTED! +X gold ***`
- Bounty board auto-refreshes with new targets

### Technical Implementation

**New Method: `AutoCompleteBountyForNPC()`** (QuestSystem.cs)
```csharp
public static long AutoCompleteBountyForNPC(Character player, string npcName)
{
    // Find ALL bounties targeting this NPC
    // Give immediate gold + XP reward
    // Mark bounty as completed
    // Return total reward for display
}
```

**Integration with Combat** (StreetEncounterSystem.cs)
- Called from `FightNPC()` when player defeats an NPC
- Shows bounty reward message to player
- Adds bounty gold to combat results

**Bounty Board Improvements:**
- `RefreshKingBounties()` now prevents duplicate bounties for same NPC
- Checks `n.IsAlive` - only living NPCs can be targets
- Dead NPC bounties automatically removed
- New bounties generated to replace completed ones

### Consolidation
- Anchor Road "B" (Bounty Hunting) now redirects to Quest Hall
- Anchor Road "Q" (Quests) now redirects to Quest Hall
- All quest/bounty activity consolidated in one location
- Removed duplicate legacy bounty system from Anchor Road

---

## Inventory System Improvements

### Backpack Display
Players can now see unequipped items in their inventory:
- New `DisplayBackpack()` method shows items not currently equipped
- Items displayed with index numbers (B1, B2, B3...)
- Shows item name, value, and stat bonuses

### Equip from Backpack
Added ability to equip items directly from backpack:
- `B#` command (e.g., B1, B2) to manage backpack items
- `ManageBackpackItem()` shows options: View, Equip, Drop
- `EquipFromBackpack()` handles the equipping logic

### Magic Shop Items Fix
Magic Shop items (rings, amulets, belts) couldn't be equipped because:
- Items had `Type = ObjType.Magic`
- But used `MagicType` for the actual slot (Fingers, Neck, Waist)
- `EquipFromBackpack()` was rejecting all `ObjType.Magic` items

**Fix:** Check `MagicType` for items with `ObjType.Magic`:
```csharp
if (item.Type == ObjType.Magic)
{
    targetSlot = (int)item.MagicType switch
    {
        5 => EquipmentSlot.LFinger,   // MagicItemType.Fingers
        10 => EquipmentSlot.Neck,     // MagicItemType.Neck
        9 => EquipmentSlot.Waist,     // MagicItemType.Waist
        _ => EquipmentSlot.MainHand   // Non-equippable
    };
}
```

### Dynamic Equipment Registration
Added `EquipmentDatabase.RegisterDynamic()` for shop-bought items:
- Items from shops don't have database IDs
- New items get IDs starting at 100000
- Allows proper equipment tracking for dynamically-created items

---

## Bug Fixes

### Character→Player Casting Error
**Problem:** Anchor Road threw `InvalidCastException` when accepting quests
```
Unable to cast object of type 'Character' to type 'Player'
```

**Fix:** Changed unsafe cast to safe pattern:
```csharp
// Before (crash)
var result = QuestSystem.ClaimQuest((Player)currentPlayer, quest);

// After (safe)
var playerObj = currentPlayer as Player ?? new Player { Name2 = currentPlayer.Name2 };
var result = QuestSystem.ClaimQuest(playerObj, quest);
```

---

## Files Modified

| File | Changes |
|------|---------|
| `usurper-reloaded.csproj` | Upgrade to .NET 8.0 |
| `README.md` | Remove Godot refs, add Discord link |
| `CLAUDE.md` | Remove Godot refs, add Discord link |
| `Scripts/Core/GameEngine.cs` | Update credits, add Discord |
| `Scripts/Systems/QuestSystem.cs` | Bounty system overhaul |
| `Scripts/Systems/StreetEncounterSystem.cs` | Bounty reward integration |
| `Scripts/Systems/InventorySystem.cs` | Backpack display, equip from bag |
| `Scripts/Data/EquipmentData.cs` | Dynamic equipment registration |
| `Scripts/Locations/AnchorRoadLocation.cs` | Redirect to Quest Hall |
| `Scripts/Locations/MagicShopLocation.cs` | Fix return navigation |

---

## Build Status

- **0 Errors**
- **479 Warnings** (mostly nullable reference types)
- **Successfully published** to `./publish/`

---

## Impact on Gameplay

### For Players:
1. **Bounties just work** - Kill an NPC with a bounty, get paid immediately
2. **See your loot** - Backpack shows all picked-up items
3. **Equip shop items** - Rings, amulets, belts from Magic Shop now equippable
4. **Cleaner navigation** - All quests/bounties in one place (Quest Hall)

### For the Codebase:
1. **Modern runtime** - .NET 8.0 LTS support until 2026
2. **Consolidated systems** - One quest/bounty system, not two
3. **Better architecture** - Open contract bounties, not claim-based

---

## Git Commit

```
47bdd8d - Upgrade to .NET 8.0, fix bounty system, inventory improvements
```

---

## Next Steps

1. Test bounty rewards in various combat scenarios
2. Verify quest completion flow end-to-end
3. Consider adding bounty notification when NPC is targeted
4. Add more starter quests for early game content

---

**The bounty hunters can finally get paid.**
